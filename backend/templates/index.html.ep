<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective National Budget</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.5/dist/chartjs-plugin-dragdata.min.js"></script>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     HEADER
     ═══════════════════════════════════════════════════════════ -->
<header id="app-header">
    <div class="header-inner">
        <h1>&#x1F3DB; Collective National Budget</h1>
        <p class="tagline">A democratic experiment: How would <em>you</em> divide the nation's resources?</p>
        <div id="auth-area">
            <!-- Filled by JS -->
        </div>
    </div>
</header>

<!-- ═══════════════════════════════════════════════════════════
     MAIN CONTENT
     ═══════════════════════════════════════════════════════════ -->
<main>

    <!-- Explanatory section -->
    <section id="explainer" class="card">
        <h2>How It Works</h2>
        <p>
            This tool lets every citizen express how they'd allocate the national budget.
            The pie chart below shows the <strong>collective average</strong> of all participants'
            choices. Log in to adjust your own allocations — your changes are private but contribute
            to the collective picture.
        </p>
        <ul class="how-list">
            <li><strong>View mode:</strong> See the collective average — what the people want.</li>
            <li><strong>Edit mode:</strong> Log in, then drag pie slices or type percentages to set your personal allocation.</li>
            <li><strong>Drill down:</strong> Click any slice to explore sub-categories (e.g., Defense → Army, Navy, …).</li>
            <li><strong>100% rule:</strong> When you change one slice, all others adjust proportionally so the total always stays at 100%.</li>
        </ul>
    </section>

    <!-- Breadcrumb navigation -->
    <nav id="breadcrumbs" class="card" aria-label="Budget navigation">
        <!-- Filled by JS -->
    </nav>

    <!-- Mode toggle -->
    <div id="mode-bar" class="card">
        <div class="mode-toggle">
            <button id="btn-view" class="mode-btn active" onclick="switchMode('view')">
                &#x1F441; View Collective
            </button>
            <button id="btn-edit" class="mode-btn" onclick="switchMode('edit')" disabled>
                &#x270F;&#xFE0F; Edit My Allocation
            </button>
        </div>
        <div id="stats-bar">
            <!-- Participation stats filled by JS -->
        </div>
    </div>

    <!-- Chart + Legend grid -->
    <div id="budget-workspace" class="card">
        <div id="chart-col">
            <canvas id="budgetChart" aria-label="Budget allocation pie chart"></canvas>
            <p id="chart-hint" class="hint">Click a slice to drill into sub-categories</p>
        </div>
        <div id="legend-col">
            <h3 id="legend-title">Allocations</h3>
            <div id="editable-legend">
                <!-- Rows generated by JS -->
            </div>
            <div id="legend-footer">
                <div class="total-row">
                    <span>Total</span>
                    <span id="legend-total">100.00%</span>
                </div>
                <button id="btn-save" class="save-btn" onclick="saveAllocations()" style="display:none;">
                    &#x1F4BE; Save My Allocation
                </button>
                <button id="btn-back" class="back-btn" onclick="goUp()">
                    &#x2B06;&#xFE0F; Go Up One Level
                </button>
            </div>
        </div>
    </div>

    <!-- About / methodology -->
    <section id="methodology" class="card">
        <h2>Methodology</h2>
        <p>
            <strong>Proportional adjustment:</strong> When you change slice <em>i</em> to a new
            value V<sub>i,new</sub>, the difference &Delta; = V<sub>i,new</sub> &minus; V<sub>i,old</sub>
            is redistributed across every other slice <em>j</em> in proportion to its current share
            of the remaining budget:
        </p>
        <div class="formula">
            V<sub>j,new</sub> = V<sub>j,old</sub> &minus;
            (&Delta; &times; V<sub>j,old</sub> / (100 &minus; V<sub>i,old</sub>))
        </div>
        <p>
            This ensures the total always sums to exactly 100%, and no single adjustment distorts
            smaller categories unfairly. Values are clamped to [0, 100] and rounded to two decimal places.
        </p>
    </section>

</main>

<!-- ═══════════════════════════════════════════════════════════
     LOGIN MODAL
     ═══════════════════════════════════════════════════════════ -->
<div id="login-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <h2>Log In to Edit</h2>
        <p>Enter your credentials to set your personal budget allocation.</p>
        <div class="form-group">
            <label for="login-user">Username</label>
            <input type="text" id="login-user" placeholder="demo" autocomplete="username">
        </div>
        <div class="form-group">
            <label for="login-pass">Password</label>
            <input type="password" id="login-pass" placeholder="demo123" autocomplete="current-password">
        </div>
        <div id="login-error" class="error-msg" style="display:none;"></div>
        <div class="modal-actions">
            <button onclick="doLogin()" class="primary-btn">Log In</button>
            <button onclick="closeLoginModal()" class="secondary-btn">Cancel</button>
        </div>
        <p class="demo-hint">Demo credentials: <code>demo</code> / <code>demo123</code></p>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     FOOTER
     ═══════════════════════════════════════════════════════════ -->
<footer>
    <p>Collective National Budget &mdash; A civic engagement prototype.</p>
</footer>

<script src="/js/budget.js"></script>
</body>
</html>
